language: python

python:
  - "3.5"
node_js:
  - ""

cache: pip

install:
    - pip install -r python_client/requirements.txt
    - pip install -r upload/requirements.txt
    - nvm install 8
    - npm install -g @angular/cli
    - (cd client/sims-backbone;npm install)
    - (cd client/sims-backbone;sed -i -e "s/url(\([-a-zA-Z0-9\.]*\))/url('\1')/" ./node_modules/material-design-icons/iconfont/material-icons.css)

script:
  - (cd test;python3 -m pytest)
  - (cd upload/test;./run.sh)
  - (cd client/sims-backbone;xvfb-run -a ng test --single-run --no-progress --browser=ChromeNoSandbox)
    #  - (cd client/sims-backbone;xvfb-run -a ng e2e --no-progress --config=protractor-ci.conf.js)

services:
    - postgresql

before_install:
    - ./generate.sh

before_script:
    - psql -c 'create database backbone_service;' -U postgres
    - psql -U postgres -c "create extension postgis" backbone_service
    - export DB_USER="postgres"
    - psql -c "\i database/backbone_service.psql;" -U ${DB_USER} backbone_service
    - psql -c 'ALTER DATABASE backbone_service SET search_path=public, backbone_service, contrib;' -U postgres
    - psql -c "SELECT postgis_full_version();" -U ${DB_USER} backbone_service
    - psql -c "\d" -U ${DB_USER} backbone_service
    - psql -c "\copy countries (English, French, alpha2, alpha3, numeric_code) FROM './database/country_codes.tsv' DELIMITER E'\t'  HEADER CSV; " -U ${DB_USER} backbone_service
    - psql -c "\copy taxonomies (id, rank, name) FROM './database/taxa.tsv' DELIMITER E'\t'  HEADER CSV;" -U ${DB_USER} backbone_service
    - (cd server;./run.sh build)
    - (cd server;./run.sh &)
    - sleep 5
    - export PYTHONPATH=$(pwd)/python_client

addons:
    postgresql: "9.6"
    apt:
      packages:
        - postgresql-9.6-postgis-2.3
    chrome: stable

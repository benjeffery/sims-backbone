language: python

python:
  - "3.5"

cache: pip

install:
    - pip install -r python_client/requirements.txt
    - pip install -r upload/requirements.txt

script:
  - (cd test;python3 -m pytest)
  - (cd upload/test;./run.sh)

services:
    - postgresql

before_install:
    - ./generate.sh

before_script:
    - psql -c 'create database backbone_service;' -U postgres
    - psql -U postgres -c "create extension postgis" backbone_service
    - export DB_USER="postgres"
    - psql -c "\i database/backbone_service.psql;" -U ${DB_USER} backbone_service
    - psql -c 'ALTER DATABASE backbone_service SET search_path=public, backbone_service, contrib;' -U postgres
    - psql -c "SELECT postgis_full_version();" -U ${DB_USER} backbone_service
    - psql -c "\d" -U ${DB_USER} backbone_service
    - psql -c "\copy countries (English, French, alpha2, alpha3, numeric_code) FROM './database/country_codes.tsv' DELIMITER E'\t'  HEADER CSV; " -U ${DB_USER} backbone_service
    - psql -c "\copy taxonomies (id, rank, name) FROM './database/taxa.tsv' DELIMITER E'\t'  HEADER CSV;" -U ${DB_USER} backbone_service
    - (cd server;./run.sh build)
    - (cd server;./run.sh &)
    - sleep 5
    - export PYTHONPATH=$(pwd)/python_client

addons:
    postgresql: "9.6"
    apt:
      packages:
        - postgresql-9.6-postgis-2.3
